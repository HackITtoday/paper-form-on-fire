<link rel="import" href="../polymer/polymer.html" />
<link rel="import" href="../firebase-element/firebase-element.html" />
<link rel="import" href="../paper-datepicker/paper-datepicker.html" />
<link rel="import" href="../paper-input/paper-input.html" />
<link rel="import" href="../paper-button/paper-button.html" />
<link rel="import" href="../paper-toast/paper-toast.html">
<link rel="import" href="../paper-dropdown-menu/paper-dropdown-menu.html">

<polymer-element name="paper-form-on-fire" attributes="firebase_url_data firebase_url_form link linkText">
  <template id="paper-form-on-fire">
  <template applyAuthorStyles bind if="{{link}}">
    <a href="#!" on-click="{{loadFrom}}" >{{linkText}}</a>
  </template>
  <template bind if="{{!link}}">
    <paper-button on-click="{{loadFrom}}" raised role="button" tabindex="0"> 
      {{linkText}}
    </paper-button>
  </template>
  <paper-action-dialog id="loadFrom" backdrop autoCloseDisabled >

      <firebase-element id="base" location="{{firebase_url_data}}"> </firebase-element>
      <firebase-element id="form" location="{{firebase_url_form}}" data="{{form}}" keys="{{keys}}" dataready> </firebase-element>
      <template id="theForm" repeat="{{x in keys}}">
        <template if="{{form[x].type == 'date'}}">
          <paper-datepicker locale="{{form[x].format}}" formatDate="ll" datePicked="{{data[form[x].id]}}" ></paper-datepicker>
        </template>

        <template if="{{(form[x].type == 'text' || form[x].type == 'email' || form[x].type == 'number' )}}">
          <paper-input-decorator error="{{form[x].error}}" id="decorator-{{form[x].id}}" label="{{x|removeLeadingNumber}} {{form[x].required|requiredStar}}" floatinglabel >
            <input value="{{data[form[x].id]}}" is="core-input" type="{{form[x].type}}" id="{{form[x].id}}" {{form[x].required|required}} on-input="{{inputAction}}"></input>
	  </paper-input-decorator>
        </template>
        <template if="{{form[x].type == 'textarea'}}">
          <paper-input-decorator error="{{form[x].error}}" label="{{x|removeLeadingNumber}}" floatinglabel >
            <textarea value="{{data[form[x].id]}}" is="core-input" type="{{form[x].type}}" id="{{form[x].id}}" ></textarea>
	  </paper-input-decorator>
        </template>
        
        <template if="{{form[x].type == 'option'}}">
          <paper-dropdown-menu label="{{x|removeLeadingNumber}}">
              <paper-dropdown class="dropdown">
                  <core-menu class="menu">
                    <template repeat="{{option in form[x].options}}">
                      <paper-item>{{option}}</paper-item>
                    </template>
                  </core-menu>
              </paper-dropdown>
          </paper-dropdown-menu>
        </template>
        
        <template if="{{!form[x].type}}">
          {{form[x]}}
        </template>
      </template>
      <div horizontal layout>
      </div>
    <paper-button label="CANCEL" affirmative>CANCEL</paper-button>
    <paper-button label="OK" affirmative id="ok" disabled="{{notFilledIn}}" on-click="{{addEntry}}">OK</paper-button>
  </paper-action-dialog>
 <paper-toast raised text="Your Message has Been sent" id="toast1" touch-action="none" class="core-transition core-transition-bottom"></paper-toast>
 <paper-toast raised text="Your Message has NOT Been sent PHONE US NOW" id="toast2" touch-action="none" class="core-transition core-transition-bottom"></paper-toast>
 <paper-toast raised text="Please fill in the form" id="toast3" touch-action="none" class="core-transition core-transition-bottom"></paper-toast>
</template>
    <script>
      Polymer('paper-form-on-fire', {

        // initialize the element's model
        ready: function() {
        },
       loadFrom: function(e) {
         this.$.loadFrom.toggle();
       },
       data:{},
       inputAction:function(e) {
         var posting = copy(this.data); 
         var schema = copy(this.form); 
         listOfInputs = Object.keys(schema);
         notFilledIn = false;
         listOfInputs.forEach(function (key) {
           if (schema[key].required && posting[schema[key].id] == undefined ) {
             notFilledIn = true;
           } 
         });
         this.notFilledIn = notFilledIn;
         var d = document.querySelectorAll("html /deep/ #decorator-"+e.target.id);
         if (d[0]) {
           d[0].isInvalid = !e.target.validity.valid;
           if (d[0].isInvalid) {
             this.notFilledIn = true;
           }
         }
       },
       notFilledIn:true,
       addEntry: function() {
         var posting = copy(this.data); 
         var schema = copy(this.form); 
         var notFilledIn = false;
         listOfInputs = Object.keys(schema);
         listOfInputs.forEach(function (key) {
           if ((schema[key].required+"" == "1" ) && posting[schema[key].id] == undefined ) {
             notFilledIn = true;
           } else {
             posting[schema[key].id] = posting[schema[key].id]+"";
             var d = document.querySelectorAll("html paper-form-on-fire /deep/ #"+schema[key].id);
             if (d[0]) {
               if (!d[0].validity.valid) notFilledIn = true;
             }
           }
         });
         if (!notFilledIn) {
	   if (this.$.base.push(posting) != false) {
             this.$.toast1.show();// Sent
             this.ready();
           } else {
             this.$.toast2.show();// Not sent
           }
         } else {
           this.$.toast3.show();// Not fill in
           this.$.loadFrom.toggle();// 
           this.notFilledIn = true;
           return false;
         }
       },
       removeLeadingNumber: function(str){
         return str.match(/^[0-9]+\s+(.*)$/)[1];// need to add a if
       },
       requiredStar:  function(str){
         if (str+""=="1") return ' *';
         // if (str+""=="1") return '<span class="form-required" title="This field is required.">*</span>';
       },
       required:  function(str){
         if (str+""=="1") return "required";
       }
      });
function copy(o) {
  var copy = Object.create(Object.getPrototypeOf(o));
  var propNames = Object.getOwnPropertyNames(o);

  propNames.forEach(function(name) {
    var desc = Object.getOwnPropertyDescriptor(o, name);
    Object.defineProperty(copy, name, desc);
  });

  return copy;
}
  </script>
  </polymer-element>
</html>
